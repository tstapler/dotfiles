# LiteLLM Proxy Configuration
# Strategy: Anthropic API first, Bedrock fallback on quota/rate errors
# OAuth passthrough via oauth_passthrough.py callback

model_list:
  # ============================================
  # CLAUDE OPUS 4.5 - PRIMARY (Anthropic Direct)
  # ============================================
  - model_name: claude-opus-4-5-20251101
    litellm_params:
      model: anthropic/claude-opus-4-5-20251101
      configurable_clientside_auth_params: ["api_key"]
    model_info:
      id: anthropic-opus-4-5

  # ============================================
  # CLAUDE OPUS 4.5 - FALLBACK (Bedrock)
  # ============================================
  - model_name: claude-opus-4-5-20251101-bedrock
    litellm_params:
      model: bedrock/us.anthropic.claude-opus-4-5-20251101-v1:0
      aws_region_name: os.environ/AWS_REGION
    model_info:
      id: bedrock-opus-4-5

  # ============================================
  # CLAUDE SONNET 4.5 - PRIMARY (Anthropic Direct)
  # ============================================
  - model_name: claude-sonnet-4-5-20250929
    litellm_params:
      model: anthropic/claude-sonnet-4-5-20250929
    model_info:
      id: anthropic-sonnet-4-5

  # ============================================
  # CLAUDE SONNET 4.5 - FALLBACK (Bedrock)
  # ============================================
  - model_name: claude-sonnet-4-5-20250929-bedrock
    litellm_params:
      model: bedrock/us.anthropic.claude-sonnet-4-5-20250929-v1:0
      aws_region_name: os.environ/AWS_REGION
    model_info:
      id: bedrock-sonnet-4-5

  # ============================================
  # CLAUDE OPUS 4 - PRIMARY (Anthropic Direct)
  # ============================================
  - model_name: claude-opus-4-20250514
    litellm_params:
      model: anthropic/claude-opus-4-20250514
    model_info:
      id: anthropic-opus-4

  # ============================================
  # CLAUDE OPUS 4 - FALLBACK (Bedrock)
  # ============================================
  - model_name: claude-opus-4-20250514-bedrock
    litellm_params:
      model: bedrock/us.anthropic.claude-opus-4-20250514-v1:0
      aws_region_name: os.environ/AWS_REGION
    model_info:
      id: bedrock-opus-4

  # ============================================
  # CLAUDE SONNET 4 - PRIMARY (Anthropic Direct)
  # ============================================
  - model_name: claude-sonnet-4-20250514
    litellm_params:
      model: anthropic/claude-sonnet-4-20250514
    model_info:
      id: anthropic-sonnet-4

  # ============================================
  # CLAUDE SONNET 4 - FALLBACK (Bedrock)
  # ============================================
  - model_name: claude-sonnet-4-20250514-bedrock
    litellm_params:
      model: bedrock/us.anthropic.claude-sonnet-4-20250514-v1:0
      aws_region_name: os.environ/AWS_REGION
    model_info:
      id: bedrock-sonnet-4

  # ============================================
  # CLAUDE 3.7 SONNET - PRIMARY (Anthropic Direct)
  # ============================================
  - model_name: claude-3-7-sonnet-20250219
    litellm_params:
      model: anthropic/claude-3-7-sonnet-20250219
    model_info:
      id: anthropic-3-7-sonnet

  # ============================================
  # CLAUDE 3.7 SONNET - FALLBACK (Bedrock)
  # ============================================
  - model_name: claude-3-7-sonnet-20250219-bedrock
    litellm_params:
      model: bedrock/us.anthropic.claude-3-7-sonnet-20250219-v1:0
      aws_region_name: os.environ/AWS_REGION
    model_info:
      id: bedrock-3-7-sonnet

  # ============================================
  # CLAUDE 3.5 SONNET - PRIMARY (Anthropic Direct)
  # ============================================
  - model_name: claude-3-5-sonnet-20241022
    litellm_params:
      model: anthropic/claude-3-5-sonnet-20241022
    model_info:
      id: anthropic-3-5-sonnet

  # ============================================
  # CLAUDE 3.5 SONNET - FALLBACK (Bedrock)
  # ============================================
  - model_name: claude-3-5-sonnet-20241022-bedrock
    litellm_params:
      model: bedrock/us.anthropic.claude-3-5-sonnet-20241022-v2:0
      aws_region_name: os.environ/AWS_REGION
    model_info:
      id: bedrock-3-5-sonnet

  # ============================================
  # CLAUDE 3.5 HAIKU - PRIMARY (Anthropic Direct)
  # ============================================
  - model_name: claude-3-5-haiku-20241022
    litellm_params:
      model: anthropic/claude-3-5-haiku-20241022
    model_info:
      id: anthropic-3-5-haiku

  # ============================================
  # CLAUDE 3.5 HAIKU - FALLBACK (Bedrock)
  # ============================================
  - model_name: claude-3-5-haiku-20241022-bedrock
    litellm_params:
      model: bedrock/us.anthropic.claude-3-5-haiku-20241022-v1:0
      aws_region_name: os.environ/AWS_REGION
    model_info:
      id: bedrock-3-5-haiku

  # ============================================
  # CLAUDE HAIKU 4.5 - PRIMARY (Anthropic Direct)
  # ============================================
  - model_name: claude-haiku-4-5-20251001
    litellm_params:
      model: anthropic/claude-haiku-4-5-20251001
    model_info:
      id: anthropic-haiku-4-5

  # ============================================
  # CLAUDE HAIKU 4.5 - FALLBACK (Bedrock)
  # ============================================
  - model_name: claude-haiku-4-5-20251001-bedrock
    litellm_params:
      model: bedrock/us.anthropic.claude-haiku-4-5-20251001-v1:0
      aws_region_name: os.environ/AWS_REGION
    model_info:
      id: bedrock-haiku-4-5

  # ============================================
  # CLAUDE 3 OPUS - PRIMARY (Anthropic Direct)
  # ============================================
  - model_name: claude-3-opus-20240229
    litellm_params:
      model: anthropic/claude-3-opus-20240229
    model_info:
      id: anthropic-3-opus

  # ============================================
  # CLAUDE 3 OPUS - FALLBACK (Bedrock)
  # ============================================
  - model_name: claude-3-opus-20240229-bedrock
    litellm_params:
      model: bedrock/us.anthropic.claude-3-opus-20240229-v1:0
      aws_region_name: os.environ/AWS_REGION
    model_info:
      id: bedrock-3-opus

  # ============================================
  # CLAUDE 3 HAIKU - PRIMARY (Anthropic Direct)
  # ============================================
  - model_name: claude-3-haiku-20240307
    litellm_params:
      model: anthropic/claude-3-haiku-20240307
    model_info:
      id: anthropic-3-haiku

  # ============================================
  # CLAUDE 3 HAIKU - FALLBACK (Bedrock)
  # ============================================
  - model_name: claude-3-haiku-20240307-bedrock
    litellm_params:
      model: bedrock/us.anthropic.claude-3-haiku-20240307-v1:0
      aws_region_name: os.environ/AWS_REGION
    model_info:
      id: bedrock-3-haiku

  # ============================================
  # MODEL ALIASES - Primary (Anthropic with fallback)
  # ============================================
  - model_name: claude-opus
    litellm_params:
      model: anthropic/claude-opus-4-5-20251101
    model_info:
      id: alias-anthropic-opus

  - model_name: claude-sonnet
    litellm_params:
      model: anthropic/claude-sonnet-4-5-20250929
    model_info:
      id: alias-anthropic-sonnet

  - model_name: claude-haiku
    litellm_params:
      model: anthropic/claude-haiku-4-5-20251001
    model_info:
      id: alias-anthropic-haiku

  # ============================================
  # MODEL ALIASES - Bedrock only (explicit bypass)
  # ============================================
  - model_name: claude-opus-bedrock
    litellm_params:
      model: bedrock/us.anthropic.claude-opus-4-5-20251101-v1:0
      aws_region_name: os.environ/AWS_REGION
    model_info:
      id: alias-bedrock-opus

  - model_name: claude-sonnet-bedrock
    litellm_params:
      model: bedrock/us.anthropic.claude-sonnet-4-5-20250929-v1:0
      aws_region_name: os.environ/AWS_REGION
    model_info:
      id: alias-bedrock-sonnet

  - model_name: claude-haiku-bedrock
    litellm_params:
      model: bedrock/us.anthropic.claude-haiku-4-5-20251001-v1:0
      aws_region_name: os.environ/AWS_REGION
    model_info:
      id: alias-bedrock-haiku

# Router settings with fallback configuration
# Optimized for FAST automatic rate limit (429) fallback to Bedrock
router_settings:
  # Request timeout in seconds (keep reasonable for legitimate requests)
  timeout: 60

  # Retry settings for transient errors (not rate limits)
  # Set to 0 for immediate fallback without retries on explicit errors
  num_retries: 0
  retry_after: 0

  # Fallback trigger settings
  # allowed_fails: Number of failures before triggering fallback
  # Set to 1 for immediate fallback on first rate limit
  allowed_fails: 1

  # cooldown_time: Seconds to wait before retrying the primary model
  # Set to 300 (5 min) for rate limits - they need longer cooldown
  cooldown_time: 300

  # Retry policy for specific error types
  # Rate limits trigger immediate fallback (no retries on same model)
  retry_policy:
    RateLimitError:
      num_retries: 0  # Don't retry rate limits, fallback immediately
    AuthenticationError:
      num_retries: 0  # Don't retry auth errors
    ContentPolicyViolationError:
      num_retries: 0  # Don't retry policy violations

  fallbacks:
    # Versioned models - Anthropic to Bedrock fallback
    - {"claude-opus-4-5-20251101": ["claude-opus-4-5-20251101-bedrock"]}
    - {"claude-sonnet-4-5-20250929": ["claude-sonnet-4-5-20250929-bedrock"]}
    - {"claude-opus-4-20250514": ["claude-opus-4-20250514-bedrock"]}
    - {"claude-sonnet-4-20250514": ["claude-sonnet-4-20250514-bedrock"]}
    - {"claude-3-7-sonnet-20250219": ["claude-3-7-sonnet-20250219-bedrock"]}
    - {"claude-3-5-sonnet-20241022": ["claude-3-5-sonnet-20241022-bedrock"]}
    - {"claude-3-5-haiku-20241022": ["claude-3-5-haiku-20241022-bedrock"]}
    - {"claude-haiku-4-5-20251001": ["claude-haiku-4-5-20251001-bedrock"]}
    - {"claude-3-opus-20240229": ["claude-3-opus-20240229-bedrock"]}
    - {"claude-3-haiku-20240307": ["claude-3-haiku-20240307-bedrock"]}
    # Aliases - Anthropic to Bedrock fallback
    - {"claude-opus": ["claude-opus-bedrock"]}
    - {"claude-sonnet": ["claude-sonnet-bedrock"]}
    - {"claude-haiku": ["claude-haiku-bedrock"]}

# LiteLLM settings
litellm_settings:
  num_retries: 0  # No retries for faster fallback
  request_timeout: 60  # Keep reasonable timeout for legitimate requests
  drop_params: true  # Drop unsupported parameters
  callbacks: [oauth_passthrough.proxy_handler_instance]
  # Drop beta flag which causes issues with Bedrock
  drop_extra_params: ["beta"]

# General proxy settings
general_settings:
  database_url: os.environ/DATABASE_URL
  # Custom auth that accepts Anthropic OAuth tokens as valid proxy keys
  custom_auth: custom_auth.user_api_key_auth
  # Disable background health checks
  enable_health_check: false
  # Forward client headers (including Authorization) to LLM API
  forward_client_headers_to_llm_api: true
  # UI Authentication (separate from API)
  ui_username: "admin"
  ui_password: "litellm-proxy-2024"
  ui_access_mode: "admin"
  # Passthrough endpoints for direct Anthropic access with OAuth support
  # These endpoints add OAuth headers automatically
  pass_through_endpoints:
    # Main messages endpoint
    - path: "/anthropic/v1/messages"
      target: "https://api.anthropic.com/v1/messages"
      forward_headers: true
      headers:
        anthropic-beta: "oauth-2025-04-20"
    # Event logging endpoint (used by Claude Code in interactive mode)
    - path: "/anthropic/api/event_logging/batch"
      target: "https://api.anthropic.com/api/event_logging/batch"
      forward_headers: true
      headers:
        anthropic-beta: "oauth-2025-04-20"
    # Catch-all for any other Anthropic API endpoints
    - path: "/anthropic/"
      target: "https://api.anthropic.com/"
      forward_headers: true
      headers:
        anthropic-beta: "oauth-2025-04-20"

# Environment variables reference:
# - CLAUDE_CODE_OAUTH_TOKEN: OAuth token for Anthropic API (primary)
# - AWS_PROFILE: AWS SSO profile with Bedrock access (fallback)
# - AWS_REGION: AWS region (e.g., us-west-2)
# - DATABASE_URL: Database connection string (optional)
#
# Automatic Fallback Behavior:
# 1. Requests first try Anthropic API using CLAUDE_CODE_OAUTH_TOKEN
# 2. On rate limit (429), immediately falls back to Bedrock
# 3. Primary model enters cooldown for 5 minutes
# 4. After cooldown, primary is tried again
